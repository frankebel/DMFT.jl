using LinearAlgebra
using DMFT
using Test

@testset "natural orbitals" begin
    Δ = get_hyb(11)
    m = Matrix(Δ)
    H, n_occ = to_natural_orbitals(m)

    @test n_occ === 6
    @test size(H) === (12, 12)
    d = diag(H)
    @test norm(d[1:6] + d[7:12]) < 3E-14 # PHS
    @test ishermitian(H)
    @test H ≈ [
        -5.551115123125783e-17 0.3666114760822126 0.0 0.0 0.0 0.0 -0.8550976851855241 -0.3666114760822127 0.0 0.0 0.0 0.0
        0.3666114760822126 -1.0152302184087838 0.4711704775408592 0.0 0.0 0.0 0.36661147608221256 0.0 0.0 0.0 0.0 0.0
        0.0 0.4711704775408592 -1.103069038676343 -0.4209553704382026 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
        0.0 0.0 -0.4209553704382026 -1.224241080048526 -0.3460825268674939 0.0 0.0 0.0 0.0 0.0 0.0 0.0
        0.0 0.0 0.0 -0.3460825268674939 -1.4077773642670075 0.23057025892190525 0.0 0.0 0.0 0.0 0.0 0.0
        0.0 0.0 0.0 0.0 0.23057025892190525 -1.690814423972567 0.0 0.0 0.0 0.0 0.0 0.0
        -0.8550976851855241 0.36661147608221256 0.0 0.0 0.0 0.0 2.220446049250313e-16 0.36661147608221273 0.0 0.0 0.0 0.0
        -0.3666114760822127 0.0 0.0 0.0 0.0 0.0 0.36661147608221273 1.0152302184087854 -0.47117047754086055 0.0 0.0 0.0
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 -0.47117047754086055 1.103069038676346 0.42095537043820225 0.0 0.0
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.42095537043820225 1.2242410800485246 -0.3460825268674972 0.0
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -0.3460825268674972 1.4077773642670095 -0.2305702589219088
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -0.2305702589219088 1.690814423972562
    ] atol = 1E-13

    Δ = get_hyb(301)
    m = Matrix(Δ)
    H, n_occ = to_natural_orbitals(m)
    @test n_occ === 151
    E = eigvals(H)
    @test norm(E[1:151] + reverse(E[152:end])) < 8E-8

    # non-hermitian matrix
    m = rand(10, 10)
    @test_throws ArgumentError to_natural_orbitals(m)

    # complex matrix
    m = rand(ComplexF64, 10, 10)
    m = 0.5 * (m + m')
    @test_throws MethodError to_natural_orbitals(m)
end # natural orbitals
